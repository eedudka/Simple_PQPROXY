# Simple PQ Proxy 

–ü—Ä–æ—Å—Ç–æ–π –∏ –ª–µ–≥–∫–∏–π MITM-forward-proxy —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Post-Quantum TLS (OpenSSL-OQS, mlkem768) –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –ª–∏—Å—Ç–æ–≤—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.

---

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **PQ-TLS-–ø–µ—Ä–µ–ø–∞–∫–æ–≤–∫–∞**: –∫–ª–∏–µ–Ω—Ç‚Üí–ø—Ä–æ–∫—Å–∏ via —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π HTTPS, –ø—Ä–æ–∫—Å–∏‚Üíorigin via –≥–∏–±—Ä–∏–¥ TLS 1.3 (X25519 + ML-KEM-768)  
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ leaf-—Å–µ—Ä—Ç—ã**: –ø—Ä–æ–∫—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç `CN=—Ü–µ–ª–µ–≤–æ–π_—Ö–æ—Å—Ç`/`SAN=‚Ä¶` –Ω–∞ –ª–µ—Ç—É, –∏—Å–ø–æ–ª—å–∑—É—è –≤–∞—à PFX(–±–µ–∑ –ø–∞—Ä–æ–ª—è) –∫–∞–∫ –∫–æ—Ä–Ω–µ–≤–æ–π CA  
- **fallback**: –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–∏–±—Ä–∏–¥ PQ-–≥—Ä—É–ø–ø—É –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é –≥—Ä—É–ø–ø—É –≤ `pqp.json`  

---

## ‚öôÔ∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- [.NET 9.0 SDK+](https://dotnet.microsoft.com/download)  
- [OpenSSL 3.2 (–∏–ª–∏ –≤—ã—à–µ)](https://github.com/openssl/openssl) - –¥–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω –Ω–∞ Openssl 3.5.1 
- [OQS Provider 0.9.0](https://github.com/open-quantum-safe/oqs-provider/)
- [Liboqs 0.14.0](https://github.com/open-quantum-safe/liboqs)
- –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π PFX-—Ñ–∞–π–ª —Å –∫–æ—Ä–Ω–µ–≤—ã–º CA –±–µ–∑ –ø–∞—Ä–æ–ª—è (`configs/pqp.json`) 

---

## –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∞—à–µ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ CA
``` openssl genrsa -out rootCA.key 4096  ```
- ca.cnf
```yaml
[ req ]
default_bits       = 4096
prompt             = no
default_md         = sha256
distinguished_name = dn
x509_extensions    = v3_ca

[ dn ]
C  = RU
ST = Moscow
L  = Moscow
O  = MyCompany
CN = my-proxy.local

[ v3_ca ]
basicConstraints = critical,CA:TRUE,pathlen:0
keyUsage         = critical,keyCertSign,cRLSign
subjectKeyIdentifier = hash
subjectAltName   = @alt_names

[ v3_req ]
basicConstraints   = CA:FALSE
keyUsage           = critical,digitalSignature,keyEncipherment
subjectAltName     = @alt_names

[ alt_names ]
DNS.1 = *your domain*
IP.1  = *your server ip*
```
- –°–∞–º–æ–ø–æ–¥–ø–∏—Å–Ω–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç CA (10 –ª–µ—Ç)
``` openssl req -x509 -new -nodes -key rootCA.key -out rootCA.crt -days 3650 -config ca.cnf ```

- CSR –∏ –∫–ª—é—á leaf
``` openssl pkcs12 -export   -inkey rootCA.key   -in rootCA.crt   -out proxy.pfx   -passout pass: ```

- –°–æ–∑–¥–∞–Ω–∏–µ PFX
```
openssl pkcs12 -export -out proxy.pfx -inkey proxy.key -in proxy.crt -certfile rootCA.crt -passout pass:
```
- –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ:
```
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ rootCA.crt –≤ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã.
–ü–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ —Å–µ—Ä—Ç–µ—Ñ–∏–∫–∞—Ç –≤ ...\pqproxy.server\configs\crts\
–£–∫–∞–∂–∏—Ç–µ –≤ pqp.json –Ω–∞–∑–≤–∞–Ω–∏–µ pfx —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
```

---


## üõ† –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

- –í pqp.json —É–∫–∞–∂–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –≥—Ä—É–ø–ø—ã
    –ù–∞–ø—Ä–∏–º–µ—Ä: 
    - `x25519mlkem768:x25519` –¥–ª—è —Ä–∞–±–æ—Ç—ã –∫–∞–∫ —Å PQ —Ç–∞–∫ 
    -  `x25519` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ç–æ–ª—å–∫–æ —Å –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º
    - `x25519mlkem768` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ç–æ–ª—å–∫–æ —Å PQ
 ``` json
    "pq.methods": {
      "kem": "x25519mlkem768:x25519",
      "cipher_suite": "TLS_AES_256_GCM_SHA384",
      "signature": "falscon512"
    },
```

- –í configs/pqp.json —É–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –¥–æ —Å–≤–æ–µ–≥–æ pfx —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ 

```json
"ssl": {
      "pq_key": "crts/falcon-key.pem",
      "pq_cert": "crts/falcon-crt.pem",
      "key": "configs/crts/my-proxy.key",
      "cert": "configs/crts/my-proxy.crt",
      "pbx":"configs/crts/my-proxy.pfx",
      "pq_pbx":""
    },
```

- –í configs/pqp.json —É–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –¥–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ Openssl c –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ OQS

```json
 "lib_paths": {
      "openssl": "/usr/local/openssl-3.5.1/",
      "oqs_lib": "/lib64",
      "ossl-modules": "/lib64/ossl-modules"
    }
```

---

## üîç –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

1. **PQ-TLS —á–µ—Ä–µ–∑ Cloudflare**  
   `curl --proxy http://localhost:3443 -v https://pq.cloudflareresearch.com/`  

2. **–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –¥–ª—è Windows**
  –ü—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä -> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä –≤ —Ä—É—á–Ω—É—é:  
   - –ê–¥—Ä–µ—Å—Å: http://–∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞   
   - –ü—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä -> –ü–æ—Ä—Ç -> 3443 (–∏–ª–∏ —Ç–æ—Ç —á—Ç–æ –≤—ã —É–∫–∞–∑–∞–ª–∏ –≤ pqp.json)  
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

---
## –ß—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—Å—è –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ PQ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:
 - –Ω–∞ Windows –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ - Wireshark
 - –Ω–∞ Linux tshark - sudo `tshark -i any -f "tcp port 443 and host pq.cloudflareresearch.com" -Y "tls.handshake" -V `

---

## –ê–Ω–∞–ª–∏–∑ Wireshark/tshark:

### –ù–∞–π–¥–∏—Ç–µ –≤ Tls Handshake
 - **–ü—Ä–∏–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ mlkem + x25519** 
    1. Supported Group: Unknown (0x11ec)
    2. Supported Group: x25519 (0x001d) 
    3. Key Share Entry: Group: Unknown (4588), Key Exchange length: 1120
- **–ü—Ä–∏–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ mlkem** –≤—Å–µ –±—É–¥–µ—Ç —Ç–æ–∂–µ —Å–∞–º–æ–µ, –Ω–æ –¥–æ–ª–∂–Ω–∞ –æ—Ç—Å—É—Ç–≤–æ–≤–∞—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∞ x25519 (0x001d)
- **–ü—Ä–∏–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ x25519** –æ–∂–∏–¥–∞–µ–º –æ—Ç—Å—É—Ç–≤–∏–µ Unknown (0x11ec) –∏ (4588)
---

## üìñ –î–∞–ª—å–Ω–µ–π—à–∏–µ –ø–ª–∞–Ω—ã 1 —ç—Ç–∞–ø–∞

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**  
   - –ö—ç—à leaf-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤  
   - –ü—É–ª PQ-TLS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π & session tickets  
   - I/O-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (Pipelines, ArrayPool)  
2. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ & –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**   
   - –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
   - –£–ª—É—á—à–µ–Ω–∏–µ –∏ —É–ø—Ä–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
3. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å & –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**  
   - Graceful shutdown –∏ retry/backoff  
   - health-endpoint  
   - Docker-Compose/Kubernetes readiness

---

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–¥ [Apache 2.0 License](LICENSE).
